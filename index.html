<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Caja del DÃ­a</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Fraunces:ital,wght@0,300;0,600;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #22263a;
    --border: #2e3347;
    --accent-green: #4ade80;
    --accent-red: #f87171;
    --accent-yellow: #fbbf24;
    --text: #e8eaf0;
    --text-muted: #6b7280;
    --radius: 14px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 0 0 100px 0;
  }

  header {
    padding: 24px 20px 16px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--bg);
    z-index: 10;
  }

  .header-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .app-title {
    font-family: 'Fraunces', serif;
    font-size: 22px;
    font-weight: 600;
    color: var(--text);
    line-height: 1;
  }

  .app-subtitle {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 4px;
    letter-spacing: 0.05em;
  }

  .fecha-badge {
    font-size: 11px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 10px;
    color: var(--text-muted);
    text-align: right;
    line-height: 1.4;
  }

  .resumen-strip {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1px;
    background: var(--border);
    margin: 0;
  }

  .resumen-item {
    background: var(--surface);
    padding: 14px 16px;
    text-align: center;
  }

  .resumen-label {
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .resumen-valor {
    font-size: 18px;
    font-weight: 600;
    font-family: 'Fraunces', serif;
  }

  .resumen-valor.verde { color: var(--accent-green); }
  .resumen-valor.rojo { color: var(--accent-red); }
  .resumen-valor.amarillo { color: var(--accent-yellow); }

  .caja-inicial-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }

  .caja-inicial-label {
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .caja-inicial-input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 7px 12px;
    color: var(--text);
    font-family: 'Fraunces', serif;
    font-size: 16px;
    font-weight: 600;
    text-align: right;
    outline: none;
    transition: border-color 0.2s;
    min-width: 0;
  }

  .caja-inicial-input:focus { border-color: var(--accent-yellow); }

  .caja-inicial-input:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .caja-final-label {
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 0.06em;
    text-transform: uppercase;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .caja-final-valor {
    font-family: 'Fraunces', serif;
    font-size: 16px;
    font-weight: 600;
    color: var(--accent-yellow);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .bottom-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 12px 20px;
    background: var(--bg);
    border-top: 1px solid var(--border);
    display: flex;
    gap: 8px;
  }

  .btn-whatsapp {
    flex: 2;
    padding: 14px;
    border-radius: var(--radius);
    border: 1px solid #25d366;
    background: rgba(37, 211, 102, 0.1);
    color: #25d366;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
  }

  .btn-whatsapp:active { background: rgba(37, 211, 102, 0.2); }

  .btn-limpiar {
    flex: 1;
    padding: 14px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text-muted);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .btn-limpiar:active { background: var(--surface2); }

  .tabs {
    display: flex;
    padding: 16px 20px 0;
    gap: 8px;
  }

  .tab {
    flex: 1;
    padding: 10px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text-muted);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .tab.active-ingreso {
    background: rgba(74, 222, 128, 0.12);
    border-color: var(--accent-green);
    color: var(--accent-green);
  }

  .tab.active-egreso {
    background: rgba(248, 113, 113, 0.12);
    border-color: var(--accent-red);
    color: var(--accent-red);
  }

  .form-area {
    padding: 16px 20px;
  }

  .form-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .field label {
    display: block;
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .options-grid {
    display: grid;
    gap: 8px;
  }

  .options-grid.cols-2 { grid-template-columns: 1fr 1fr; }
  .options-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }

  .opt-btn {
    padding: 10px 8px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text-muted);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
  }

  .opt-btn.sel-ingreso {
    background: rgba(74, 222, 128, 0.15);
    border-color: var(--accent-green);
    color: var(--accent-green);
  }

  .opt-btn.sel-egreso {
    background: rgba(248, 113, 113, 0.15);
    border-color: var(--accent-red);
    color: var(--accent-red);
  }

  .opt-btn.sel-medio {
    background: rgba(251, 191, 36, 0.15);
    border-color: var(--accent-yellow);
    color: var(--accent-yellow);
  }

  .monto-input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    color: var(--text);
    font-family: 'Fraunces', serif;
    font-size: 28px;
    font-weight: 600;
    text-align: center;
    outline: none;
    transition: border-color 0.2s;
  }

  .monto-input:focus {
    border-color: var(--accent-yellow);
  }

  .monto-input::placeholder {
    color: var(--text-muted);
    font-size: 16px;
  }

  .btn-agregar {
    width: 100%;
    padding: 14px;
    border-radius: var(--radius);
    border: none;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.05em;
  }

  .btn-agregar.ingreso {
    background: var(--accent-green);
    color: #0a1f0f;
  }

  .btn-agregar.egreso {
    background: var(--accent-red);
    color: #1f0a0a;
  }

  .btn-agregar:active {
    transform: scale(0.97);
  }

  .movimientos-area {
    padding: 0 20px;
  }

  .section-title {
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 10px;
    padding-top: 4px;
  }

  .mov-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .mov-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .mov-left {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .mov-concepto {
    font-size: 12px;
    color: var(--text);
  }

  .mov-meta {
    font-size: 10px;
    color: var(--text-muted);
  }

  .mov-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
  }

  .mov-monto {
    font-size: 15px;
    font-weight: 600;
    font-family: 'Fraunces', serif;
  }

  .mov-monto.verde { color: var(--accent-green); }
  .mov-monto.rojo { color: var(--accent-red); }

  .mov-del {
    font-size: 10px;
    color: var(--text-muted);
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: none;
    font-family: 'DM Mono', monospace;
  }

  .empty-state {
    text-align: center;
    padding: 30px 0;
    color: var(--text-muted);
    font-size: 12px;
    line-height: 1.8;
  }

  .bottom-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 12px 20px;
    background: var(--bg);
    border-top: 1px solid var(--border);
  }

  .btn-whatsapp {
    width: 100%;
    padding: 14px;
    border-radius: var(--radius);
    border: 1px solid #25d366;
    background: rgba(37, 211, 102, 0.1);
    color: #25d366;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
  }

  .btn-whatsapp:active {
    background: rgba(37, 211, 102, 0.2);
  }

  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-80px);
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 20px;
    font-size: 12px;
    color: var(--text);
    transition: transform 0.3s;
    z-index: 100;
    white-space: nowrap;
  }

  .toast.show {
    transform: translateX(-50%) translateY(0);
  }

  .divider {
    height: 1px;
    background: var(--border);
    margin: 16px 20px;
  }

  .logo {
  height: 65px;
  width: auto;
  border-radius: 12px;
  }

  input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }
</style>
</head>
<body>

<header>
  <div class="header-top">
    <div style="display:flex; align-items:center; gap:12px;">
      <img src="logo.png" alt="Logo Veterinaria Los Lapachos" class="logo">
      <div>
        <div class="app-title">Caja del DÃ­a</div>
        <div class="app-subtitle">Veterinaria Los Lapachos</div>
      </div>
    </div>
    <div class="fecha-badge" id="fechaBadge"></div>
  </div>
</header>

<div class="resumen-strip">
  <div class="resumen-item">
    <div class="resumen-label">Ingresos</div>
    <div class="resumen-valor verde" id="totalIngresos">$0</div>
  </div>
  <div class="resumen-item">
    <div class="resumen-label">Egresos</div>
    <div class="resumen-valor rojo" id="totalEgresos">$0</div>
  </div>
  <div class="resumen-item">
    <div class="resumen-label">Neto</div>
    <div class="resumen-valor amarillo" id="totalNeto">$0</div>
  </div>
</div>

<div class="caja-inicial-bar">
  <span class="caja-inicial-label">Caja inicial</span>
  <input type="number" class="caja-inicial-input" id="cajaInicialInput" placeholder="$0" inputmode="numeric"
    onblur="confirmarCajaInicial()" onkeydown="if(event.key==='Enter'){this.blur()}">
  <span class="caja-final-label">En caja</span>
  <span class="caja-final-valor" id="cajaFinalValor">â€”</span>
</div>

<div class="tabs">
  <button class="tab active-ingreso" id="tabIngreso" onclick="setTipo('ingreso')">+ Ingreso</button>
  <button class="tab" id="tabEgreso" onclick="setTipo('egreso')">âˆ’ Egreso</button>
</div>

<div class="form-area">
  <div class="form-card">

    <div class="field" id="fieldConcepto">
      <label>Concepto</label>
      <div class="options-grid cols-2" id="conceptoOptions"></div>
    </div>

    <div class="field" id="fieldMedios">
      <label>Medio de pago</label>
      <div class="options-grid cols-3" id="mediosGrid">
        <button class="opt-btn" id="medio-efectivo" onclick="setMedio('efectivo')">Efectivo</button>
        <button class="opt-btn" id="medio-transferencia" onclick="setMedio('transferencia')">Transfer.</button>
        <button class="opt-btn" id="medio-tarjeta" onclick="setMedio('tarjeta')">Tarjeta</button>
      </div>
    </div>

    <div class="field">
      <label>Monto</label>
      <input type="number" class="monto-input" id="montoInput" placeholder="$ 0" inputmode="numeric">
    </div>

    <button class="btn-agregar ingreso" id="btnAgregar" onclick="agregar()">AGREGAR INGRESO</button>
  </div>
</div>

<div class="divider"></div>

<div class="movimientos-area">
  <div class="section-title">Movimientos de hoy</div>
  <div class="mov-list" id="movList"></div>
</div>

<div class="bottom-bar">
  <button class="btn-whatsapp" onclick="enviarWhatsApp()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="#25d366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
    Enviar resumen
  </button>
  <button class="btn-limpiar" onclick="limpiarRegistros()">ðŸ—‘ Limpiar</button>
</div>

<div class="toast" id="toast"></div>

<script>
// ====== CONFIG ======
const MI_NUMERO = '5493772637058';
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxPn9ZdpBpqIWVtTve-zhtyfX2pr11qx5oSwYP4iTQsSncDGRqPUznGSJLd_-o201g/exec';
const POLL_INTERVAL = 10000;

const CONCEPTOS = {
  ingreso: ['Venta producto', 'ClÃ­nica'],
  egreso: ['Sueldo', 'Retiro', 'Otro']
};

// ====== STATE ======
let tipo = 'ingreso';
let concepto = '';
let medio = '';
let pollTimer = null;

// ====== HELPERS ======
const hoy = () => new Date().toISOString().split('T')[0];

function getMovimientos() {
  return JSON.parse(localStorage.getItem('movimientos') || '[]');
}
function saveMovimientos(movs) {
  localStorage.setItem('movimientos', JSON.stringify(movs));
}
function formatPeso(n) {
  return '$' + Number(n).toLocaleString('es-AR');
}
function formatFecha(iso) {
  const [y, m, d] = iso.split('-');
  return `${d}/${m}/${y}`;
}
function horaActual() {
  const now = new Date();
  return String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
}

// ====== CAJA INICIAL ======
function getCajaInicialLocal() {
  const data = JSON.parse(localStorage.getItem('cajaInicial') || '{}');
  if (data.fecha !== hoy()) return 0;
  return data.monto || 0;
}
function saveCajaInicialLocal(monto) {
  localStorage.setItem('cajaInicial', JSON.stringify({ fecha: hoy(), monto }));
}

function confirmarCajaInicial() {
  const input = document.getElementById('cajaInicialInput');
  const monto = parseFloat(input.value) || 0;
  if (!monto) return;

  // Bloquear el campo â€” ya no se puede modificar
  input.disabled = true;
  saveCajaInicialLocal(monto);
  recalcularCajaFinal();

  // Guardar en Sheet en segundo plano
  sheetPost({ action: 'guardarCajaInicial', fecha: hoy(), monto });
}

function recalcularCajaFinal() {
  const cajaInicial = getCajaInicialLocal();
  const el = document.getElementById('cajaFinalValor');
  if (!cajaInicial) { el.textContent = 'â€”'; return; }

  const movs = getMovimientos().filter(m => m.fecha === hoy());
  // Solo efectivo afecta la caja fÃ­sica
  const ingEfectivo = movs.filter(m => m.tipo === 'ingreso' && m.medio === 'efectivo').reduce((s, m) => s + m.monto, 0);
  const egEfectivo  = movs.filter(m => m.tipo === 'egreso'  && m.medio === 'efectivo').reduce((s, m) => s + m.monto, 0);
  el.textContent = formatPeso(cajaInicial + ingEfectivo - egEfectivo);
}

// ====== SHEET SYNC ======
async function sheetPost(data) {
  try {
    await fetch(SHEET_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
  } catch(e) {
    console.warn('sheetPost error:', e);
  }
}

async function sincronizarDesdeSheet() {
  try {
    const res = await fetch(SHEET_URL + '?t=' + Date.now());
    const data = await res.json();
    if (!data.ok) return;

    // --- Movimientos ---
    const locales  = getMovimientos();
    const idsLocales = new Set(locales.map(m => String(m.id)));
    const idsSheet   = new Set(data.movimientos.map(m => String(m.id)));
    const nuevos     = data.movimientos.filter(m => !idsLocales.has(String(m.id)));
    const filtrados  = locales.filter(m => idsSheet.has(String(m.id)));

    if (nuevos.length > 0 || filtrados.length !== locales.length) {
      const merged = [...filtrados, ...nuevos];
      merged.sort((a, b) => (a.fecha + a.hora).localeCompare(b.fecha + b.hora));
      saveMovimientos(merged);
      renderMovimientos();
      renderResumen();
    }

    // --- Caja inicial desde Sheet (solo si no hay valor local bloqueado de hoy) ---
    if (data.cajaInicial && data.cajaInicial[hoy()] && !getCajaInicialLocal()) {
      const montoSheet = data.cajaInicial[hoy()];
      saveCajaInicialLocal(montoSheet);
      const input = document.getElementById('cajaInicialInput');
      input.value = montoSheet;
      input.disabled = true;
      recalcularCajaFinal();
    }

  } catch(e) { /* silencioso */ }
}

function iniciarPolling() {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(sincronizarDesdeSheet, POLL_INTERVAL);
}

// ====== UI ======
function setTipo(t) {
  tipo = t; concepto = ''; medio = '';
  document.getElementById('tabIngreso').className = 'tab' + (t === 'ingreso' ? ' active-ingreso' : '');
  document.getElementById('tabEgreso').className  = 'tab' + (t === 'egreso'  ? ' active-egreso'  : '');
  document.getElementById('btnAgregar').className = 'btn-agregar ' + t;
  document.getElementById('btnAgregar').textContent = t === 'ingreso' ? 'AGREGAR INGRESO' : 'AGREGAR EGRESO';
  const tarjeta = document.getElementById('medio-tarjeta');
  if (tarjeta) tarjeta.style.display = t === 'ingreso' ? '' : 'none';
  const grid = document.getElementById('mediosGrid');
  if (grid) grid.className = 'options-grid cols-' + (t === 'ingreso' ? '3' : '2');
  renderConceptos();
  clearMedios();
}

function renderConceptos() {
  const opts = CONCEPTOS[tipo];
  const el = document.getElementById('conceptoOptions');
  el.className = 'options-grid cols-' + (opts.length <= 2 ? '2' : '3');
  el.innerHTML = opts.map(c =>
    `<button class="opt-btn" id="con-${c.replace(/ /g,'_')}" onclick="setConcepto('${c}')">${c}</button>`
  ).join('');
}

function setConcepto(c) {
  concepto = c;
  CONCEPTOS[tipo].forEach(x => {
    const el = document.getElementById('con-' + x.replace(/ /g,'_'));
    if (el) el.className = 'opt-btn' + (x === c ? (tipo === 'ingreso' ? ' sel-ingreso' : ' sel-egreso') : '');
  });
}

function setMedio(m) {
  medio = m;
  ['efectivo','transferencia','tarjeta'].forEach(x => {
    const el = document.getElementById('medio-' + x);
    if (el) el.className = 'opt-btn' + (x === m ? ' sel-medio' : '');
  });
}

function clearMedios() {
  ['efectivo','transferencia','tarjeta'].forEach(m => {
    const el = document.getElementById('medio-' + m);
    if (el) el.className = 'opt-btn';
  });
  medio = '';
}

async function agregar() {
  const monto = parseFloat(document.getElementById('montoInput').value);
  if (!concepto) { showToast('ElegÃ­ un concepto'); return; }
  if (!medio)    { showToast('ElegÃ­ el medio de pago'); return; }
  if (!monto || monto <= 0) { showToast('IngresÃ¡ un monto vÃ¡lido'); return; }

  const mov = { id: Date.now(), fecha: hoy(), hora: horaActual(), tipo, concepto, medio, monto };
  const movs = getMovimientos();
  movs.push(mov);
  saveMovimientos(movs);

  document.getElementById('montoInput').value = '';
  concepto = ''; medio = '';
  renderConceptos(); clearMedios();
  renderMovimientos(); renderResumen();
  showToast('âœ“ Registrado');

  await sheetPost({ action: 'agregar', ...mov });
  await sincronizarDesdeSheet();
}

async function eliminar(id) {
  const movs = getMovimientos();
  const mov = movs.find(m => m.id === id);
  saveMovimientos(movs.filter(m => m.id !== id));
  renderMovimientos(); renderResumen();
  if (mov) await sheetPost({ action: 'eliminar', ...mov });
}

function limpiarRegistros() {
  const todos = getMovimientos();
  if (!todos.length) { showToast('No hay registros para limpiar'); return; }
  if (!confirm('Â¿Limpiar todos los registros de la app? El Sheet no se toca.')) return;
  saveMovimientos([]);
  // TambiÃ©n limpiar caja inicial local
  localStorage.removeItem('cajaInicial');
  const input = document.getElementById('cajaInicialInput');
  input.value = '';
  input.disabled = false;
  document.getElementById('cajaFinalValor').textContent = 'â€”';
  renderMovimientos(); renderResumen();
  showToast('Registros limpiados âœ“');
}

function renderMovimientos() {
  const movs = getMovimientos().filter(m => m.fecha === hoy()).reverse();
  const el = document.getElementById('movList');
  if (!movs.length) {
    el.innerHTML = '<div class="empty-state">Sin movimientos hoy.<br>EmpezÃ¡ cargando el primero.</div>';
    return;
  }
  el.innerHTML = movs.map(m => `
    <div class="mov-item">
      <div class="mov-left">
        <div class="mov-concepto">${m.concepto}</div>
        <div class="mov-meta">${m.hora}${m.medio ? ' Â· ' + m.medio : ''}</div>
      </div>
      <div class="mov-right">
        <div class="mov-monto ${m.tipo === 'ingreso' ? 'verde' : 'rojo'}">
          ${m.tipo === 'ingreso' ? '+' : 'âˆ’'}${formatPeso(m.monto)}
        </div>
        <button class="mov-del" onclick="eliminar(${m.id})">borrar</button>
      </div>
    </div>
  `).join('');
}

function renderResumen() {
  const movs = getMovimientos().filter(m => m.fecha === hoy());
  const ingresos = movs.filter(m => m.tipo === 'ingreso').reduce((s, m) => s + m.monto, 0);
  const egresos  = movs.filter(m => m.tipo === 'egreso').reduce((s, m) => s + m.monto, 0);
  document.getElementById('totalIngresos').textContent = formatPeso(ingresos);
  document.getElementById('totalEgresos').textContent  = formatPeso(egresos);
  document.getElementById('totalNeto').textContent     = formatPeso(ingresos - egresos);
  recalcularCajaFinal();
}

function renderFecha() {
  const now = new Date();
  const dias  = ['Dom','Lun','Mar','MiÃ©','Jue','Vie','SÃ¡b'];
  const meses = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
  document.getElementById('fechaBadge').innerHTML =
    `${dias[now.getDay()]} ${now.getDate()} ${meses[now.getMonth()]}<br>${now.getFullYear()}`;
}

function armarMensajeWA(movs, fecha) {
  const ingresos = movs.filter(m => m.tipo === 'ingreso');
  const egresos  = movs.filter(m => m.tipo === 'egreso');
  const totalI   = ingresos.reduce((s, m) => s + m.monto, 0);
  const totalE   = egresos.reduce((s, m) => s + m.monto, 0);

  let msg = `ðŸ¾ *Resumen del dÃ­a - ${formatFecha(fecha)}*\n`;

  if (ingresos.length) {
    msg += `\nâœ… *INGRESOS*\n`;
    // Agrupar por concepto
    const porConcepto = {};
    ingresos.forEach(m => {
      if (!porConcepto[m.concepto]) porConcepto[m.concepto] = {};
      if (!porConcepto[m.concepto][m.medio]) porConcepto[m.concepto][m.medio] = 0;
      porConcepto[m.concepto][m.medio] += m.monto;
    });
    Object.entries(porConcepto).forEach(([conc, medios]) => {
      const subtotal = Object.values(medios).reduce((s, v) => s + v, 0);
      msg += `\n  *${conc}*\n`;
      Object.entries(medios).forEach(([med, tot]) => {
        msg += `    Â· ${med.charAt(0).toUpperCase() + med.slice(1)}: ${formatPeso(tot)}\n`;
      });
      msg += `    _Subtotal: ${formatPeso(subtotal)}_\n`;
    });
    msg += `\n  *Total ingresos: ${formatPeso(totalI)}*\n`;
  }

  if (egresos.length) {
    msg += `\nâŒ *EGRESOS*\n`;
    const porConcepto = {};
    egresos.forEach(m => {
      if (!porConcepto[m.concepto]) porConcepto[m.concepto] = {};
      if (!porConcepto[m.concepto][m.medio]) porConcepto[m.concepto][m.medio] = 0;
      porConcepto[m.concepto][m.medio] += m.monto;
    });
    Object.entries(porConcepto).forEach(([conc, medios]) => {
      const subtotal = Object.values(medios).reduce((s, v) => s + v, 0);
      msg += `\n  *${conc}*\n`;
      Object.entries(medios).forEach(([med, tot]) => {
        msg += `    Â· ${med.charAt(0).toUpperCase() + med.slice(1)}: ${formatPeso(tot)}\n`;
      });
      msg += `    _Subtotal: ${formatPeso(subtotal)}_\n`;
    });
    msg += `\n  *Total egresos: ${formatPeso(totalE)}*\n`;
  }

  msg += `\nðŸ’° *NETO DEL DÃA: ${formatPeso(totalI - totalE)}*`;
  return msg;
}

function enviarWhatsApp() {
  const todos = getMovimientos();
  if (!todos.length) { showToast('No hay movimientos para enviar'); return; }

  const fechaEnvio = todos[0].fecha;
  const movs = todos.filter(m => m.fecha === fechaEnvio);
  const msg = armarMensajeWA(movs, fechaEnvio);

  window.open(`https://wa.me/${MI_NUMERO}?text=${encodeURIComponent(msg)}`, '_blank');
  showToast('Resumen enviado âœ“');
  // NO borra automÃ¡tico â€” el empleado usa el botÃ³n Limpiar cuando quiera
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ====== BOOTSTRAP ======
renderFecha();
renderConceptos();
setTipo('ingreso');
const cajaGuardada = getCajaInicialLocal();
if (cajaGuardada > 0) {
  const input = document.getElementById('cajaInicialInput');
  input.value = cajaGuardada;
  input.disabled = true;
}
sincronizarDesdeSheet().then(() => {
  renderMovimientos();
  renderResumen();
});
iniciarPolling();
</script>
</body>
</html>
